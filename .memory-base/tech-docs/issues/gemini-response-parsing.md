# Gemini: устойчивость парсинга и ротации ключей

## Summary
- Клиент Gemini полагается на `response.text`, тогда как SDK `google-genai` отдаёт данные через `candidates[].content.parts[].text`, что может привести к `AttributeError` и пустым рекомендациям.
- Счётчики использования ключей инкрементируются до получения успешного ответа, поэтому при сетевых ошибках ключи «сгорают» без результата.
- При API-ошибках 5xx или непредвиденных исключениях нет повторов с тем же ключом и бэк‑оффа; часть ошибок пробрасывается сразу.
- Пометка ключа как `invalid` необратима (нет clear/unmark), пул не восстановится после временных проблем.

## Impact
- Рекомендации могут не возвращаться вовсе при изменении формата ответа, падая до парсинга.
- Быстрое исчерпание лимита ключей на сетевых сбоях → ранний `AllKeysExhaustedException` и остановка батча.
- Временные ошибки (5xx) не пережидаются, повышается доля неудачных попыток.
- Исправленные ключи остаются исключёнными, требуя ручного вмешательства.

## Findings (code refs)
- Парсинг ответа: требуется доставать текст из `response.candidates[0].content.parts[0].text`, а не из `response.text`.
- Подсчёт usage: инкремент до успешного ответа расходует лимит при ошибках сети.
- Ретраи: для 5xx/непредвиденных исключений нет backoff с повтором; rotation без паузы.
- Invalid-flag: нет метода очистки флага и пересоздания пула.

## Recommendations
- Явно разбирать структуру `google-genai` с fallback к поиску JSON в parts, затем в text; добавлять строгую валидацию `summary/tips`.
- Инкрементировать usage после успешного ответа; отдельно учитывать ошибки (error_count) в метриках.
- Добавить обобщённый retry/backoff для 5xx и сетевых исключений перед ротацией ключа; ограничить общее число попыток.
- Добавить `unmark_key_invalid`/reset, поддержать метрику ротаций и долю ошибочных запросов.
- Юнит‑тесты на парсинг разных форматов ответа (JSON в code block, plain JSON, префиксы) и на политику ротации/лимитов.

