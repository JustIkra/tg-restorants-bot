# ะะธะทะฐะนะฝ ะฝะพะฒัั ััะฝะบัะธะน

## 1. ะฃะฒะตะดะพะผะปะตะฝะธั ะดะปั ะบะฐัะต ัะตัะตะท Telegram

### ะะพะดะบะปััะตะฝะธะต ะบะฐัะต

**ะคะปะพั:**
1. ะัะตะดััะฐะฒะธัะตะปั ะบะฐัะต ะฟะธัะตั ะฑะพัั โ ะฒัะฑะธัะฐะตั "ะฏ ะฟัะตะดััะฐะฒะธัะตะปั ะบะฐัะต"
2. ะะพั ะทะฐะฟัะฐัะธะฒะฐะตั ะฝะฐะทะฒะฐะฝะธะต ะบะฐัะต (ะธะปะธ ะฟะพะบะฐะทัะฒะฐะตั ัะฟะธัะพะบ)
3. ะกะพะทะดะฐัััั ะทะฐัะฒะบะฐ ะฝะฐ ะฟัะธะฒัะทะบั
4. ะะตะฝะตะดะถะตั ะฒะธะดะธั ะทะฐัะฒะบั ะฒ ะธะฝัะตััะตะนัะต โ ะฟะพะดัะฒะตัะถะดะฐะตั ะธะปะธ ะพัะบะปะพะฝัะตั
5. ะะพัะปะต ะฟะพะดัะฒะตัะถะดะตะฝะธั ะบะฐัะต ะฟะพะปััะฐะตั ัะฒะตะดะพะผะปะตะฝะธั

### ะะฑะฝะพะฒะปัะฝะฝะฐั ััะตะผะฐ Cafe

```
Cafe {
  id: int
  name: string
  description: string | null
  address: string | null          # ะฐะดัะตั ะบะฐัะต
  is_active: bool
  tg_chat_id: int | null          # Telegram ID ะฟัะธะฒัะทะฐะฝะฝะพะณะพ ัะฐัะฐ
  tg_username: string | null      # @username ะดะปั ะพัะพะฑัะฐะถะตะฝะธั
  notifications_enabled: bool     # ะผะพะถะฝะพ ะพัะบะปััะธัั ะฑะตะท ะพัะฒัะทะบะธ
  linked_at: datetime | null      # ะบะพะณะดะฐ ะฟัะธะฒัะทะฐะปะธ
  created_at: datetime
}
```

### ะะพะฒัะต API ัะฝะดะฟะพะธะฝัั

```
POST /cafes/{cafe_id}/link-request
  Auth: public (ัะตัะตะท Telegram ะฑะพัะฐ)
  Body: { tg_chat_id: int, tg_username: string }
  Response: { request_id: int, status: "pending" }

GET /cafe-requests
  Auth: manager
  Response: { items: CafeLinkRequest[] }

POST /cafe-requests/{request_id}/approve
  Auth: manager
  Response: Cafe

POST /cafe-requests/{request_id}/reject
  Auth: manager
  Response: 204

PATCH /cafes/{cafe_id}/notifications
  Auth: manager
  Body: { enabled: bool }
  Response: Cafe

DELETE /cafes/{cafe_id}/link
  Auth: manager
  Response: Cafe (ั tg_chat_id: null)
```

### ะกัะตะผะฐ CafeLinkRequest

```
CafeLinkRequest {
  id: int
  cafe_id: int
  cafe_name: string
  tg_chat_id: int
  tg_username: string
  status: "pending" | "approved" | "rejected"
  created_at: datetime
  processed_at: datetime | null
}
```

### ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน

**ะขัะธะณะณะตั:** Kafka worker `notifications` ัะปััะฐะตั ัะพะฑััะธะต `deadline.passed`

**ะะพะณะธะบะฐ:**
1. ะัะพะฒะตััะตั: ะตััั ะปะธ ะทะฐะบะฐะทั ะฝะฐ ััั ะดะฐัั ะดะปั ััะพะณะพ ะบะฐัะต?
2. ะัะปะธ ะฝะตั ะทะฐะบะฐะทะพะฒ โ ะฝะธัะตะณะพ ะฝะต ะดะตะปะฐะตั
3. ะัะปะธ ะตััั โ ัะพัะผะธััะตั ัะพะพะฑัะตะฝะธะต ะธ ะพัะฟัะฐะฒะปัะตั ะฒ `tg_chat_id`

### ะคะพัะผะฐั ัะฒะตะดะพะผะปะตะฝะธั

```
๐ ะกัะพะปะพะฒะฐั โ1 โ ะะฐะบะฐะท ะฝะฐ 06.12.2025
โโโโโโโโโโโโโโโโโโโโโ

๐ค ะะฒะฐะฝ ะะตััะพะฒ:
   โข ะะพัั (ะฑะพะปััะฐั) โ ะฑะตะท ัะผะตัะฐะฝั
   โข ะะผะตัะธะบะฐะฝะพ ร2

๐ค ะะฐัะธั ะกะธะดะพัะพะฒะฐ:
   โข ะกะฐะปะฐั ะฆะตะทะฐัั
   โข ะงะฐะน

๐ค ะะปะตะบัะตะน ะะพะทะปะพะฒ:
   โข ะะพัั (ััะฐะฝะดะฐััะฝะฐั)
   โข ะะพัะปะตัะฐ ะฟะพ-ะบะธะตะฒัะบะธ
   โข ะะพะผะฟะพั

โโโโโโโโโโโโโโโโโโโโโ
ะัะพะณะพ: 12 ะฟะพะทะธัะธะน, 4 850 โฝ
```

---

## 2. ะะตะบะพะผะตะฝะดะฐัะธะธ ัะตัะตะท Gemini API

### ะััะธัะตะบัััะฐ

**ะะพะณะดะฐ:** ะะพััั (3:00) Kafka worker `recommendations` ะทะฐะฟััะบะฐะตั batch-ะฟัะพัะตัั

**ะัะพัะตัั:**
1. ะะตััั ะฒัะตั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ะทะฐะบะฐะทะฐะผะธ ะทะฐ ะฟะพัะปะตะดะฝะธะต 30 ะดะฝะตะน
2. ะะปั ะบะฐะถะดะพะณะพ ัะพะฑะธัะฐะตั ััะฐัะธััะธะบั: ะบะฐัะตะณะพัะธะธ ะฑะปัะด, ัะฐััะพัะฐ, ัะฐะทะฝะพะพะฑัะฐะทะธะต
3. ะัะฟัะฐะฒะปัะตั ะฒ Gemini API ั ะฟัะพะผะฟัะพะผ ะดะปั ะฐะฝะฐะปะธะทะฐ ะฟะธัะฐะฝะธั
4. ะกะพััะฐะฝัะตั ัะตะทัะปััะฐั ะฒ Redis ั TTL 24 ัะฐัะฐ

**ะะธะฝะธะผัะผ ะดะปั ัะตะบะพะผะตะฝะดะฐัะธะน:** 5 ะทะฐะบะฐะทะพะฒ ะทะฐ 30 ะดะฝะตะน

### ะะฐะฝะฝัะต ะดะปั Gemini

```json
{
  "orders_last_30_days": 18,
  "categories": {
    "ะะตัะฒะพะต": 45,
    "ะะพัััะตะต": 35,
    "ะกะฐะปะฐัั": 5,
    "ะะฐะฟะธัะบะธ": 15
  },
  "unique_dishes": 8,
  "total_dishes_available": 45
}
```

### ะัะฒะตั Gemini (ะบััะธััะตััั ะฒ Redis)

```json
{
  "summary": "80% ะณะพัััะตะณะพ, ะผะฐะปะพ ะพะฒะพัะตะน ะธ ะบะปะตััะฐัะบะธ",
  "tips": [
    "ะะพะฟัะพะฑัะนัะต ะดะพะฑะฐะฒะธัั ัะฐะปะฐั ะบ ะพะฑะตะดั โ ะฒ ะผะตะฝั ะตััั ะัะตัะตัะบะธะน ะธ ะฆะตะทะฐัั",
    "ะั ะทะฐะบะฐะทัะฒะฐะตัะต ะพะดะฝะธ ะธ ัะต ะถะต 8 ะฑะปัะด โ ะฟะพะฟัะพะฑัะนัะต ััะฑะฝัะต ะดะฝะธ ะฟะพ ััะตะดะฐะผ"
  ]
}
```

### ะขะธะฟั ัะตะบะพะผะตะฝะดะฐัะธะน

- ะะตััะพะฝะฐะปัะฝัะต ะฝะฐ ะพัะฝะพะฒะต ะธััะพัะธะธ ะทะฐะบะฐะทะพะฒ
- ะะพะฟัะพะดะฐะถะธ (ะบะพะผะฑะพ, ะดะพะฟะพะปะฝะตะฝะธั)
- ะกะพะฒะตัั ะฟะพ ัะฑะฐะปะฐะฝัะธัะพะฒะฐะฝะฝะพะผั ะฟะธัะฐะฝะธั ะธ ัะฐะทะฝะพะพะฑัะฐะทะธั ัะฐัะธะพะฝะฐ

### API ัะฝะดะฟะพะธะฝั

```
GET /users/{tgid}/recommendations
  Auth: manager | self
  Response: {
    summary: string | null,
    tips: string[],
    stats: {
      orders_last_30_days: int,
      categories: { [category: string]: float },
      unique_dishes: int
    },
    generated_at: datetime | null
  }
```

ะัะปะธ ัะตะบะพะผะตะฝะดะฐัะธะน ะฝะตั (ะฝะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั, ะผะฐะปะพ ะทะฐะบะฐะทะพะฒ) โ ะฒะพะทะฒัะฐัะฐะตั `summary: null, tips: []`.

### ะัะพะฑัะฐะถะตะฝะธะต ะฝะฐ ัััะฐะฝะธัะต ะฟัะพัะธะปั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค ะะฒะฐะฝ ะะตััะพะฒ                     โ
โ  ะัะธั: ะะพัะบะฒะฐ, ะฆะตะฝััะฐะปัะฝัะน          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฐ ะะฐะปะฐะฝั                          โ
โ  ะะธะผะธั: 5 000 โฝ/ะฝะตะดะตะปั              โ
โ  ะะพััะฐัะตะฝะพ: 2 340 โฝ                 โ
โ  ะััะฐะปะพัั: 2 660 โฝ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฅ ะะฐัะต ะฟะธัะฐะฝะธะต                    โ
โ  ะะฐ ะผะตััั: 18 ะทะฐะบะฐะทะพะฒ               โ
โ  80% ะณะพัััะตะณะพ, ะผะฐะปะพ ะพะฒะพัะตะน          โ
โ                                     โ
โ  ๐ก ะะพะฟัะพะฑัะนัะต ะดะพะฑะฐะฒะธัั ัะฐะปะฐั โ     โ
โ     ะฒ ะผะตะฝั ะตััั ะัะตัะตัะบะธะน ะธ ะฆะตะทะฐัั  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะฑะฝะพะฒะปะตะฝะธะต ะฟะพะบัััะธั ััะตะฑะพะฒะฐะฝะธะน

ะะพัะปะต ัะตะฐะปะธะทะฐัะธะธ ััะธั ััะฝะบัะธะน:

| ะะตะพะฑัะทะฐัะตะปัะฝะพะต ััะตะฑะพะฒะฐะฝะธะต | ะกัะฐััั |
|---------------------------|--------|
| ะะธัะฝัะน ะฑะฐะปะฐะฝั/ััะฐัะธััะธะบะฐ | โ |
| ะญะบัะฟะพัั ัะพัะผะฐัะพะฒ | โ |
| ะัะฟัะฐะฒะบะฐ ะฒ ะบะฐัะต ะฝะฐะฟััะผัั | โ (ัะตัะตะท Telegram) |
| ะฃะผะฝัะต ะฟะพะดัะบะฐะทะบะธ | โ (Gemini API) |
