---
agent: coder
task_id: TSK-019
status: completed
created_at: 2025-12-07T12:00:00Z
next: tester
files_changed:
  - frontend_mini_app/src/components/Manager/MenuItemForm.tsx
---

# Coder: TSK-019 - Исправление бага с полем цены в форме редактирования блюда

## Выполненные изменения

### Проблема (из Debugger отчёта)

В файле `frontend_mini_app/src/components/Manager/MenuItemForm.tsx`:
- Поле цены показывалось ТОЛЬКО для категории "extra" (строки 108-123)
- Это неправильно — цена должна быть доступна для ВСЕХ категорий
- При редактировании блюда цена терялась, если категория не "extra"

### Решение

Внесены 3 ключевых изменения:

---

### 1. Убрана условная обёртка поля цены (строки 108-123)

**Было:**
```tsx
{category === "extra" && (
  <div>
    <label className="block text-sm font-medium text-gray-300 mb-2">
      Цена (₽)
    </label>
    <input
      type="number"
      step="0.01"
      min="0"
      value={price}
      onChange={(e) => setPrice(e.target.value)}
      className="w-full bg-white/10 border border-white/20 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#A020F0]"
      placeholder="50.00"
    />
  </div>
)}
```

**Стало:**
```tsx
<div>
  <label className="block text-sm font-medium text-gray-300 mb-2">
    Цена (₽)
  </label>
  <input
    type="number"
    step="0.01"
    min="0"
    value={price}
    onChange={(e) => setPrice(e.target.value)}
    className="w-full bg-white/10 border border-white/20 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#A020F0]"
    placeholder="Необязательно"
  />
</div>
```

**Изменения:**
- Убрано условие `{category === "extra" && (...)}`
- Изменён placeholder с `"50.00"` на `"Необязательно"` для ясности

**Результат:** Поле цены теперь отображается для ВСЕХ категорий блюд (soup, salad, main, extra).

---

### 2. Удалена валидация цены только для категории "extra" (строки 36-39)

**Было:**
```tsx
// Price is required only for "extra" category
if (category === "extra" && !price) {
  alert("Для категории 'Дополнительно' необходимо указать цену");
  return;
}
```

**Стало:** Код полностью удалён.

**Результат:** Теперь цена необязательна для всех категорий. Это соответствует бизнес-логике:
- Кафе может указывать цену для любого блюда (для информации или контроля)
- Цена не обязательна ни для одной категории

---

### 3. Исправлена логика передачи цены в onSubmit (строка 45)

**Было:**
```tsx
onSubmit({
  name: name.trim(),
  description: description.trim() || undefined,
  category,
  price: category === "extra" && price ? price : undefined,
});
```

**Стало:**
```tsx
onSubmit({
  name: name.trim(),
  description: description.trim() || undefined,
  category,
  price: price ? price : undefined,
});
```

**Изменения:**
- Убрано условие `category === "extra" &&`
- Теперь цена передаётся независимо от категории, если она заполнена

**Результат:** Цена корректно сохраняется для всех категорий блюд.

---

## Изменённые файлы

### `frontend_mini_app/src/components/Manager/MenuItemForm.tsx`

| Строки | Действие | Описание |
|--------|----------|----------|
| 36-39 | Удалено | Валидация цены для категории "extra" |
| 45 | Изменено | Логика передачи цены: убрано условие `category === "extra"` |
| 108-123 | Изменено | Убрана условная обёртка `{category === "extra" && (...)}` |
| 114 | Изменено | Placeholder изменён с `"50.00"` на `"Необязательно"` |

---

## Тестирование

Исправление затрагивает:
1. **Форму создания блюда** - теперь цену можно указать для любой категории
2. **Форму редактирования блюда** - цена сохраняется и отображается для всех категорий
3. **Валидацию формы** - цена стала необязательным полем для всех категорий

### Рекомендации для тестера

**Сценарий 1: Создание блюда с ценой (категория "soup")**
1. Открыть форму создания блюда
2. Заполнить название: "Борщ украинский"
3. Выбрать категорию: "Первое" (soup)
4. Указать цену: 150.00
5. Нажать "Создать"
6. **Ожидание:** Блюдо создано, цена сохранена

**Сценарий 2: Создание блюда без цены (категория "soup")**
1. Открыть форму создания блюда
2. Заполнить название: "Солянка"
3. Выбрать категорию: "Первое" (soup)
4. Оставить поле цены пустым
5. Нажать "Создать"
6. **Ожидание:** Блюдо создано, цена = null/undefined

**Сценарий 3: Редактирование существующего блюда с ценой**
1. Открыть форму редактирования блюда с ценой (любая категория)
2. Проверить, что поле цены заполнено корректным значением
3. Изменить название или описание (но не цену)
4. Нажать "Сохранить"
5. **Ожидание:** Блюдо сохранено, цена не изменилась

**Сценарий 4: Изменение цены в форме редактирования**
1. Открыть форму редактирования блюда
2. Изменить цену на новое значение (например, 120.50)
3. Нажать "Сохранить"
4. **Ожидание:** Блюдо сохранено, новая цена отобразилась

**Сценарий 5: Удаление цены (очистка поля)**
1. Открыть форму редактирования блюда с ценой
2. Очистить поле цены (удалить значение)
3. Нажать "Сохранить"
4. **Ожидание:** Блюдо сохранено, цена удалена (null/undefined)

**Сценарий 6: Создание блюда "extra" с ценой**
1. Открыть форму создания блюда
2. Заполнить название: "Сметана"
3. Выбрать категорию: "Дополнительно" (extra)
4. Указать цену: 20.00
5. Нажать "Создать"
6. **Ожидание:** Блюдо создано, цена сохранена

---

## Связь с другими компонентами

### 1. `MenuManager.tsx`
После этого фикса `MenuManager` будет корректно отображать:
- Блюда с ценой (любой категории) — показывается цена
- Блюда без цены — цена не отображается (или показывается "-")

### 2. Backend API
Backend endpoint `POST /cafes/{cafe_id}/menu` и `PUT /cafes/{cafe_id}/menu/{item_id}` принимают поле `price` как опциональное (`Optional[Decimal]`). Это соответствует новой логике frontend:
- `price: "150.00"` → отправляется как `price: 150.00`
- `price: ""` → отправляется как `price: undefined` → backend сохраняет как `NULL`

### 3. Пользовательский интерфейс (page.tsx)
На странице заказа блюда с ценой отображаются с ценой, блюда без цены — без цены. Это не должно сломаться, так как frontend уже поддерживал `price: null`.

---

## Почему это важно

До фикса:
1. Менеджер создавал блюдо категории "soup" с ценой 150₽
2. Цена НЕ сохранялась (поле было скрыто)
3. При редактировании блюда цена не отображалась
4. Менеджер не мог добавить цену для "soup"/"salad"/"main"

После фикса:
1. Менеджер создаёт блюдо любой категории с ценой
2. Цена сохраняется корректно
3. При редактировании цена отображается
4. Менеджер может добавлять/изменять/удалять цену для любой категории

---

## Консистентность с backend

Backend schema (`schemas/menu.py`):
```python
class MenuItemCreate(BaseModel):
    name: str
    description: Optional[str] = None
    category: str
    price: Optional[Decimal] = None  # Опциональное поле
```

Backend model (`models/cafe.py`):
```python
class MenuItem(Base):
    price: Mapped[Optional[Decimal]] = mapped_column(Numeric(10, 2), nullable=True)
```

Frontend теперь полностью соответствует backend:
- Поле цены опциональное для ВСЕХ категорий
- Передаётся только если заполнено
- Backend корректно обрабатывает `null` / `undefined`

---

## Статус

✅ **Completed** - все изменения внесены согласно спецификации Debugger.

## Следующий этап

→ **Tester** - написать тесты для проверки функциональности цены во всех категориях:
- Unit тесты (если есть для MenuItemForm)
- E2E тесты (Playwright) — сценарии создания/редактирования/удаления цены
- Ручное тестирование в браузере

**Примерная оценка тестирования:** 15-20 минут (E2E) + 10 минут (unit, если есть).
