---
task_id: TSK-010
title: "Добавить функционал пользователя для менеджера"
pipeline: feature
status: pending
created_at: 2025-12-06T22:30:00+03:00
created_by: task-creator
---

## Описание

Менеджер должен иметь возможность использовать функционал обычного пользователя (делать заказы, видеть меню, смотреть свои заказы и т.д.) в дополнение к административным функциям.

## Бизнес-контекст

Сейчас менеджер имеет только административный интерфейс на `/manager`. При авторизации менеджер автоматически редиректится на `/manager` и не может использовать функционал обычного пользователя.

### Проблема

- Менеджер не может делать заказы для себя
- Менеджер не может видеть меню как обычный пользователь
- Менеджер не может использовать FortuneWheel
- После авторизации менеджер всегда попадает на `/manager`, минуя пользовательский интерфейс

### Решение

Предоставить менеджеру доступ к обоим интерфейсам:
1. **Панель менеджера** (`/manager`) — административные функции
2. **Пользовательский интерфейс** (`/`) — заказы, меню, FortuneWheel

## Анализ

### Связанные файлы

| Файл | Назначение |
|------|------------|
| `frontend_mini_app/src/app/page.tsx` | Главная страница (редирект менеджера на `/manager`) |
| `frontend_mini_app/src/app/manager/page.tsx` | Панель менеджера |
| `frontend_mini_app/src/app/order/page.tsx` | Страница оформления заказа |
| `frontend_mini_app/src/app/FortuneWheel/page.tsx` | Колесо фортуны |
| `frontend_mini_app/src/lib/api/client.ts` | Функция авторизации `authenticateWithTelegram()` |
| `backend/src/models/user.py` | Модель пользователя с полем `role` |
| `backend/src/auth/dependencies.py` | Проверка роли пользователя |

### Impact

- **API:** без изменений (менеджер уже может использовать user endpoints)
- **Database:** без изменений
- **Frontend:** изменения в навигации и доступности страниц
- **Services:** без изменений

### Зависимости

- **Требует:** TSK-009 уже реализовано (панель менеджера создана)
- **Влияет на:** UX менеджера, навигация в приложении

## Acceptance Criteria

### Основная функциональность

- [ ] Менеджер может переключаться между панелью менеджера и пользовательским интерфейсом
- [ ] Менеджер может делать заказы как обычный пользователь
- [ ] Менеджер может видеть меню и использовать все функции `/` (главная, заказы, FortuneWheel)
- [ ] При авторизации менеджер попадает на `/manager` (как сейчас)
- [ ] На панели менеджера (`/manager`) есть кнопка/ссылка "Сделать заказ" → переход на `/`
- [ ] На главной странице (`/`) для менеджера есть кнопка/ссылка "Панель менеджера" → переход на `/manager`

### Навигация

- [ ] На `/manager` добавлена кнопка "Сделать заказ" или "Пользовательский интерфейс"
- [ ] На `/` (главная) для менеджера добавлена кнопка "Панель менеджера" (не показывать обычным users)
- [ ] Кнопки соответствуют дизайн-системе (purple градиенты, blur backgrounds)
- [ ] Навигация работает без потери состояния авторизации

### Защита

- [ ] Обычные users НЕ видят кнопку "Панель менеджера"
- [ ] При попытке обычного user зайти на `/manager` — редирект на `/` (уже реализовано в TSK-009)
- [ ] Менеджер может использовать все user endpoints (уже разрешено на backend)

### UX

- [ ] Переключение между интерфейсами происходит плавно (без перезагрузки авторизации)
- [ ] Иконки и текст кнопок понятны пользователю
- [ ] Мобильная адаптивность (кнопки touch-friendly, min 44px)

## Технические детали

### Текущее поведение (TSK-009)

```typescript
// frontend_mini_app/src/app/page.tsx
authenticateWithTelegram(initData)
  .then((response) => {
    setIsAuthenticated(true);
    // Редирект менеджера на /manager
    if (response.user.role === "manager") {
      router.push("/manager");
    }
  })
```

```typescript
// frontend_mini_app/src/app/manager/page.tsx
authenticateWithTelegram(initData)
  .then((response) => {
    // Проверка: если не менеджер — редирект на главную
    if (response.user.role !== "manager") {
      router.push("/");
      return;
    }
    setIsAuthenticated(true);
  })
```

### Предлагаемые изменения

#### 1. Убрать автоматический редирект менеджера с главной страницы

**Проблема:** Менеджер всегда редиректится на `/manager`, не может остаться на `/`

**Решение:**
- Убрать `router.push("/manager")` из `app/page.tsx`
- Вместо этого показать кнопку "Панель менеджера" для менеджеров

**Опциональное поведение:**
- Можно оставить редирект, но сделать его опциональным (localStorage флаг "preferredInterface")
- Или редиректить только при первом входе, затем запоминать последнюю страницу

#### 2. Добавить кнопку навигации на главной странице

```typescript
// frontend_mini_app/src/app/page.tsx

const [user, setUser] = useState<User | null>(null);

useEffect(() => {
  authenticateWithTelegram(initData)
    .then((response) => {
      setIsAuthenticated(true);
      setUser(response.user);
      // НЕ редиректить менеджера автоматически
    })
}, []);

// В JSX добавить кнопку для менеджера
{user?.role === "manager" && (
  <button
    onClick={() => router.push("/manager")}
    className="fixed top-4 right-4 z-50 px-4 py-2 bg-gradient-to-r from-[#8B23CB] to-[#A020F0] rounded-lg text-white"
  >
    Панель менеджера
  </button>
)}
```

#### 3. Добавить кнопку "Сделать заказ" на панели менеджера

```typescript
// frontend_mini_app/src/app/manager/page.tsx

// В JSX добавить кнопку
<button
  onClick={() => router.push("/")}
  className="px-4 py-2 bg-gradient-to-r from-[#8B23CB] to-[#A020F0] rounded-lg text-white"
>
  Сделать заказ
</button>
```

#### 4. Проверка прав на backend

Backend уже поддерживает:
- `CurrentUser` — любой авторизованный пользователь (user или manager)
- `ManagerUser` — только менеджеры

Эндпоинты для заказов используют `CurrentUser`, поэтому менеджеры уже могут делать заказы через API.

### Дизайн кнопок

**Кнопка "Панель менеджера" на главной странице:**
- Расположение: fixed, top-right (или в header)
- Стиль: `bg-gradient-to-r from-[#8B23CB] to-[#A020F0]`
- Иконка: `FaUserShield` или `FaGear` из `react-icons/fa6`

**Кнопка "Сделать заказ" на панели менеджера:**
- Расположение: в header панели менеджера (рядом с заголовком)
- Стиль: тот же градиент
- Иконка: `FaCartShopping` или `FaUtensils`

### Альтернативные подходы

**Вариант 1: Всегда показывать обе кнопки**
- На `/` — кнопка "Панель менеджера" (только для managers)
- На `/manager` — кнопка "Сделать заказ"

**Вариант 2: Единое меню навигации**
- Создать `<ManagerNav />` компонент с выпадающим меню
- При клике показывать:
  - "Главная" → `/`
  - "Панель менеджера" → `/manager`
  - "Заказы" → `/orders` (если будет отдельная страница)

**Вариант 3: Tabs в панели менеджера**
- Добавить вкладку "Мои заказы" в панель менеджера
- Встроить функционал пользователя прямо в `/manager`
- Не переключаться на `/`, а показывать всё на одной странице

**Рекомендуемый:** Вариант 1 (простой и понятный)

## Архитектурные решения

1. **Убрать автоматический редирект менеджера:**
   - Менеджер остаётся на `/` после авторизации
   - Может использовать пользовательский интерфейс

2. **Добавить кнопки навигации:**
   - На `/` для менеджеров — кнопка "Панель менеджера"
   - На `/manager` — кнопка "Сделать заказ" или "Главная"

3. **Проверка роли на client-side:**
   - Хранить `user` в state или localStorage
   - Условно показывать кнопку "Панель менеджера" только для managers

4. **Доступ к API:**
   - Менеджер уже может использовать user endpoints (заказы, меню)
   - Никаких изменений на backend не требуется

## Примечания

- Менеджер уже может делать заказы через API (endpoints используют `CurrentUser`)
- Нужно только убрать frontend ограничение (редирект на `/manager`)
- Можно использовать существующие компоненты (`CafeSelector`, `MenuSection`, etc.)

## Дополнительные возможности (опционально)

- [ ] Запоминать последнюю посещённую страницу (localStorage)
- [ ] Показывать badge на кнопке "Панель менеджера" с количеством новых запросов
- [ ] Анимация перехода между интерфейсами
- [ ] Хлебные крошки (breadcrumbs) для навигации

## Риски

- **UX confusion:** Менеджер может не понять, что у него два интерфейса
- **Дублирование функционала:** Если добавить "Мои заказы" и в `/` и в `/manager`

## Решения для рисков

- Чёткие названия кнопок: "Панель менеджера" и "Сделать заказ"
- Использовать иконки для визуального разделения (gear для админки, cart для заказов)
- Можно добавить подсказку при первом входе: "Вы менеджер. Вы можете использовать панель менеджера или делать заказы как обычный пользователь"
