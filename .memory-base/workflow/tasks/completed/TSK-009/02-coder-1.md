---
agent: coder
task_id: TSK-009
subtask: 1
subtask_name: "Редирект по ролям"
status: completed
next: null
created_at: 2025-12-06T21:45:00+03:00
files_changed:
  - path: frontend_mini_app/src/app/page.tsx
    action: modified
---

## Реализация

Реализован автоматический редирект для пользователей с ролью "manager" на страницу `/manager` после успешной авторизации. Также добавлено сохранение объекта пользователя в localStorage для дальнейшего использования на других страницах.

### Изменения

#### `frontend_mini_app/src/app/page.tsx`

**Модифицирован `useEffect` с авторизацией (строки 68-105):**

1. **Сохранение user объекта в localStorage:**
   ```typescript
   // Save user object to localStorage
   localStorage.setItem("user", JSON.stringify(response.user));
   ```
   Это позволяет другим страницам (включая `/manager`) получать доступ к информации о пользователе без дополнительных API запросов.

2. **Редирект по ролям:**
   ```typescript
   // Redirect manager to /manager page
   if (response.user.role === "manager") {
     router.push("/manager");
   }
   ```
   После успешной авторизации проверяется роль пользователя. Если это "manager", происходит автоматический редирект на страницу менеджерской панели. Обычные пользователи (role === "user") остаются на главной странице.

3. **Добавлена зависимость `router` в массив зависимостей useEffect:**
   ```typescript
   }, [router]);
   ```
   Это необходимо для корректной работы хука и избежания предупреждений React о пропущенных зависимостях.

### Технические детали

- **Используемые импорты:** `useRouter` из `next/navigation` (уже был импортирован на строке 21)
- **API ответ:** `authenticateWithTelegram()` возвращает `{ access_token: string; user: User }`, где `User.role` может быть "user" или "manager"
- **localStorage ключ:** "user" — содержит JSON-сериализованный объект User
- **Обратная совместимость:** Изменения не влияют на работу для обычных пользователей, они продолжают видеть главную страницу после авторизации

### Поведение

**Для обычного пользователя (role: "user"):**
1. Открывает бот
2. Telegram WebApp инициализируется
3. Авторизация через `authenticateWithTelegram()`
4. User объект сохраняется в localStorage
5. Остаётся на главной странице `/`

**Для менеджера (role: "manager"):**
1. Открывает бот
2. Telegram WebApp инициализируется
3. Авторизация через `authenticateWithTelegram()`
4. User объект сохраняется в localStorage
5. **Автоматический редирект на `/manager`**

### Следующие шаги

Эта реализация подготавливает frontend к использованию отдельной менеджерской панели. Следующие подзадачи должны:
- Создать страницу `/manager/page.tsx` с проверкой роли
- Реализовать UI для административных функций
- Добавить обработку случая, когда обычный пользователь пытается зайти на `/manager` (редирект обратно на `/`)

### Проверка

Для проверки работы изменений:
1. Авторизоваться как пользователь с ролью "manager" в Telegram Mini App
2. Убедиться, что происходит автоматический редирект на `/manager`
3. Проверить localStorage — должен содержать ключ "user" с объектом пользователя
4. Авторизоваться как обычный пользователь (role: "user")
5. Убедиться, что редирект НЕ происходит, пользователь остаётся на главной странице
